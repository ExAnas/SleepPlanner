<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>جدول دورات النوم حول صلاة الفجر</title>

  <link rel="icon" type="image/x-icon" href="favicon.ico">

  <style>
    :root{
      --bg:#0f1222; --card:#171a2e; --box:#0c0f20;
      --text:#e9ecf1; --muted:#a9b1c7; --accent:#4fd1c5;
      --danger:#eb5757; --ok:#3bb273; --warn:#e2b93b;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      display:grid; place-items:center;
      background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Naskh Arabic", "Noto Sans Arabic", Arial, sans-serif;
      line-height:1.6; padding:24px; font-size:1.1rem;
    }
    .container{width:min(1100px,100%)}
    .card{background:var(--card); border:none; border-radius:var(--radius); padding:22px}
    header{display:flex; gap:16px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:6px}
    .title{font-size:clamp(22px,4vw,30px); font-weight:800}
    .subtitle{color:var(--muted); font-size:1rem}
    .grid{display:grid; gap:14px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .badge{display:inline-flex; align-items:center; gap:6px; background:var(--box); border:none; color:var(--text); padding:8px 12px; border-radius:999px; font-size:13px}
    .section{background:var(--box); border:none; border-radius:12px; padding:16px}
    label{font-weight:700; font-size:1rem}
    input[type="time"], input[type="number"], select{
      background: var(--box); border:none; color:var(--text);
      padding:10px 12px; border-radius:10px; font-family:inherit; font-size:1rem;
    }
    .btn-primary{background:var(--accent); border:none; padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:800; font-size:1rem; color:#071b10}
    .btn-secondary,.btn-small{background:var(--box); border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700; color:var(--text); font-size:1rem}
    .btn-small{padding:8px 10px; font-size:0.95rem}
    .btn-primary:active,.btn-secondary:active,.btn-small:active{transform:translateY(1px)}
    .btn-secondary[disabled]{opacity:.5; cursor:not-allowed}
    .pills{display:flex; gap:8px; flex-wrap:wrap}
    .pill{user-select:none; background:var(--box); border:none; padding:10px 14px; border-radius:999px; cursor:pointer; font-weight:700; color:#fff; font-size:1rem}
    .pill[aria-pressed="true"]{background:rgba(79,209,197,.12); outline:2px solid var(--accent); color:#fff}
    .muted{color:var(--muted)}
    .center{display:grid; place-items:center; text-align:center}
    .result{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .result .box{background: var(--card); border:none; border-radius:12px; padding:14px}
    .ok{color:var(--ok)} .danger{color:var(--danger)}
    .hint{font-size:0.95rem; color:var(--muted)}
    .big{font-size:clamp(24px,4vw,32px); font-weight:900}
    .small{font-size:13px}
    @media (max-width:820px){.result{grid-template-columns:1fr}}
    .two-cols{display:flex; gap:16px; align-items:flex-start}
    .two-cols > div{flex:1; min-width:0}

    /* Overlays */
    .tutorial-overlay{position:fixed; inset:0; background:rgba(15,18,34,.55); backdrop-filter: blur(10px) saturate(120%); -webkit-backdrop-filter: blur(10px) saturate(120%); display:none; align-items:center; justify-content:center; z-index:9999}
    .tutorial{background:var(--card); border:none; border-radius:var(--radius); width:min(900px, 96%); padding:24px 24px 18px 24px; color:var(--text); font-size:1.05rem; line-height:1.7}
    .tutorial h2{margin:0 0 10px 0; font-size:clamp(22px,3.5vw,26px); font-weight:800}
    .tutorial p{margin:0 0 10px 0; color:var(--muted)}
    .tutorial .row-actions{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:14px}
    .tutorial .nav{display:flex; gap:8px}
    .tutorial .hint{font-size:.95rem; color:var(--muted)}

    /* مؤشّر حفظ */
    .saving-inline{display:inline-flex; align-items:center; gap:8px}
    .spinner{
      width:14px; height:14px; border-radius:50%;
      border:2px solid var(--accent);
      border-top-color: transparent;
      display:inline-block;
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    /* زر مساعدة دائري صغير */
    .btn-help{
      width:28px; height:28px; border-radius:999px; background:var(--accent);
      color:#071b10; border:none; font-weight:900; cursor:pointer; display:inline-grid; place-items:center; line-height:1; padding:0;
    }
    .btn-help:active{transform:translateY(1px)}

    /* مقياس إجمالي النوم */
    .sleep-meter{display:inline-block; padding:8px 12px; border-radius:999px; font-size:13px}
    .meter-danger{background: rgba(235,87,87,.12); outline:1px solid rgba(235,87,87,.35)}
    .meter-warn{background: rgba(226,185,59,.12); outline:1px solid rgba(226,185,59,.40)}
    .meter-ok{background: rgba(59,178,115,.12); outline:1px solid rgba(59,178,115,.35)}
  </style>
</head>
<body>
  <!-- Overlay التوتوريال القديم -->
  <div id="tutorialOverlay" class="tutorial-overlay" role="dialog" aria-modal="true" aria-labelledby="tutorialTitle">
    <div class="tutorial" id="tutorialCard"></div>
  </div>

  <!-- Overlay معلومات دورة النوم -->
  <div id="infoOverlay" class="tutorial-overlay" role="dialog" aria-modal="true" aria-labelledby="infoTitle">
    <div class="tutorial" id="infoCard">
      <h2 id="infoTitle">ما هي «دورة النوم» وليه نهتم فيها؟</h2>
      <div class="hint">
        <p><b>دورة النوم</b> هي مجموعة مراحل تتكرر طول الليل (خفيف → عميق → حركة العين السريعة). مدتها غالبًا بين <b>٩٠–١١٠ دقيقة</b>.</p>
        <p>القاعدة الذهبية: <b>لا تقطع الدورة في نصّها</b>؛ الأفضل تصحى عند نهايتها عشان تقوم أخف وأنشط.</p>
        <p>ربطناها مع <b>وقت الفجر</b> عشان تخطط: كم دورة قبل الأذان و/أو بعده (بعد وضوءك وأذكاره) بحيث تجمع نوم كافي وتصحي بنشاط للصلاة.</p>
      </div>
      <div class="row-actions">
        <span class="hint">تقدّر تفتح هالمعلومة من زر (؟) جنب “مدة الدورة”.</span>
        <div class="nav">
          <button id="infoCloseBtn" class="btn-primary" type="button">فهمت، إغلاق</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <header>
        <div>
          <div class="title">جدول دورات النوم حول صلاة الفجر</div>
          <div id="subtitle" class="subtitle">جاري تحديد الموقع وجلب وقت الفجر…</div>
        </div>
        <div class="row">
          <span id="todayBadge" class="badge">اليوم: —</span>
          <span id="tzBadge" class="badge">المنطقة الزمنية: —</span>
          <span id="cycleBadge" class="badge">مدة الدورة: 90 دقيقة</span>
          <span id="wakeBadge" class="badge">وقت الاستيقاظ: —</span>
          <span id="sunriseBadge" class="badge">الشروق: —</span>
          <!-- شارة حالة الحفظ (في البار) -->
          <span id="saveStatusBadge" class="badge" role="status" aria-live="polite">آخر حفظ: —</span>
        </div>
      </header>

      <div class="grid">
        <!-- الإعدادات -->
        <div class="section">
          <div class="row" style="justify-content:space-between; gap:16px">
            <div class="row" style="gap:12px; flex:1">
              <label for="fajrTime">وقت الفجر</label>
              <input id="fajrTime" type="time" step="60" />
              <button id="autoResetBtn" class="btn-small" type="button" title="إعادة الضبط تلقائيًا">إعادة الضبط تلقائيًا</button>
              <span id="autoNote" class="hint" style="display:none;margin-inline-start:8px;max-width:520px"></span>
            </div>

            <div class="row" style="gap:10px; align-items:center">
              <label for="cycleLength">مدة الدورة (دقائق)</label>
              <button id="cycleInfoBtn" class="btn-help" type="button" title="معلومات عن دورة النوم">?</button>
              <select id="cycleLength">
                <option value="90" selected>90 دقيقة</option>
                <option value="100">100 دقيقة</option>
                <option value="110">110 دقيقة</option>
              </select>
              <span class="hint">اختر 90 أو 100 أو 110</span>
            </div>

            <div class="row" style="gap:12px">
              <label for="wakeDelay">تأخير الاستيقاظ بعد الأذان (دقائق)</label>
              <input id="wakeDelay" type="number" min="0" max="180" value="0" style="width:90px"/>
              <span class="hint">0 = عند الأذان. مثلاً 15 أو 30 دقيقة.</span>
            </div>

            <div class="row" style="gap:12px">
              <label for="gapAfter">فاصل ما بعد الصلاة (دقائق)</label>
              <input id="gapAfter" type="number" min="0" max="120" value="30" style="width:90px"/>
              <span class="hint">مثال: 30 دقيقة للوضوء والأذكار</span>
            </div>
          </div>
        </div>

        <!-- اختيار الدورات + معاينات اختيارية -->
        <div class="section">
          <div class="two-cols">
            <div>
              <label>قبل الفجر</label>
              <div id="pillsBefore" class="pills" role="group" aria-label="عدد الدورات قبل الفجر"></div>
              <div id="previewBefore" class="hint" style="margin-top:6px; display:none"></div>
            </div>
            <div>
              <label>بعد الفجر</label>
              <div id="pillsAfter" class="pills" role="group" aria-label="عدد الدورات بعد الفجر"></div>
              <div id="previewAfter" class="hint" style="margin-top:6px; display:none"></div>
            </div>
          </div>
          <div id="idealHint" class="hint" style="margin-top:10px"></div>
        </div>

        <!-- النتائج -->
        <div id="results" class="section" style="display:none">
          <div class="center" style="margin-bottom:8px">
            <div class="big">خطتك لليلة/صباح الصلاة</div>
            <div id="totalLabel" class="small sleep-meter">—</div>
          </div>
          <div class="result">
            <div class="box">
              <b>قبل الفجر</b>
              <div id="beforeLine" class="muted">—</div>
            </div>
            <div class="box">
              <b>بعد الفجر</b>
              <div id="afterLine" class="muted">—</div>
            </div>
          </div>
          <div id="advice" class="center" style="margin-top:10px"></div>
        </div>
      </div>

      <footer style="margin-top:16px; text-align:center; color:var(--muted); font-size:0.95rem">
        <span id="footerCycle">طول الدورة الحالي = 90 دقيقة.</span> الأفضل إكمال عدد صحيح من الدورات ثم الاستيقاظ.
      </footer>
    </div>
  </div>

  <script>
    // ===== Helpers =====
    let cycleMin = 90;
    const todayBadge = document.getElementById('todayBadge');
    const tzBadge = document.getElementById('tzBadge');
    const subtitleEl = document.getElementById('subtitle');
    const cycleBadge = document.getElementById('cycleBadge');
    const footerCycle = document.getElementById('footerCycle');
    const wakeBadge = document.getElementById('wakeBadge');
    const sunriseBadge = document.getElementById('sunriseBadge');
    const saveStatusBadge = document.getElementById('saveStatusBadge');

    function pad(n){return String(n).padStart(2,'0')}
    function fmt(date){ return pad(date.getHours())+":"+pad(date.getMinutes()) }
    function addMin(date, m){ return new Date(date.getTime() + m*60000) }
    function subMin(date, m){ return new Date(date.getTime() - m*60000) }
    function makeTodayAt(hhmm){
      const [h,m] = (hhmm||'').split(':').map(Number);
      const now = new Date();
      return new Date(now.getFullYear(), now.getMonth(), now.getDate(), h||0, m||0, 0);
    }
    function humanSpan(start, end){
      const startD = new Date(start), endD = new Date(end);
      let startTag = '', endTag = '';
      const today = new Date(); today.setHours(0,0,0,0);
      const sBase = new Date(startD); sBase.setHours(0,0,0,0);
      const eBase = new Date(endD);   eBase.setHours(0,0,0,0);
      const diffS = Math.round((sBase - today)/86400000);
      const diffE = Math.round((eBase - today)/86400000);
      if (diffS < 0) startTag = ' (اليوم السابق)';
      if (diffS > 0) startTag = ' (اليوم التالي)';
      if (diffE < 0) endTag   = ' (اليوم السابق)';
      if (diffE > 0) endTag   = ' (اليوم التالي)';
      return `${fmt(start)}${startTag} → ${fmt(end)}${endTag}`;
    }

    // ——— عربي بحسب العدد
    function countWithWord(n){
      if (n === 0) return '0 دورات';
      if (n === 1) return 'دورة واحدة';
      if (n === 2) return 'دورتان';
      return `${n} دورات`;
    }
    function pillText(n){
      if (n === 0) return 'بدون';
      if (n === 1) return 'دورة';
      if (n === 2) return 'دورتان';
      return `${n} دورات`;
    }
    function hoursWord(h){
      if (h === 1) return 'ساعة واحدة';
      if (h === 2) return 'ساعتان';
      if (h >= 3 && h <= 10) return `${h} ساعات`;
      return `${h} ساعة`;
    }

    // ===== UI Setup =====
    const fajrTime = document.getElementById('fajrTime');
    const gapAfter = document.getElementById('gapAfter');
    const cycleLengthSelect = document.getElementById('cycleLength');
    const wakeDelay = document.getElementById('wakeDelay');
    const pillsBefore = document.getElementById('pillsBefore');
    const pillsAfter = document.getElementById('pillsAfter');
    const previewBefore = document.getElementById('previewBefore');
    const previewAfter = document.getElementById('previewAfter');

    const results = document.getElementById('results');
    const beforeLine = document.getElementById('beforeLine');
    const afterLine = document.getElementById('afterLine');
    const totalLbl = document.getElementById('totalLabel');
    const advice = document.getElementById('advice');
    const autoNote = document.getElementById('autoNote');
    const autoResetBtn = document.getElementById('autoResetBtn');
    const idealHint = document.getElementById('idealHint');

    const STORAGE_KEY = 'sleepFajrPrefs.v1';

    let cBefore = 0;
    let cAfter  = 0;

    // ===== حفظ تلقائي =====
    const SAVE_DEBOUNCE_MS = 800;
    let saveTimer = null;
    let IS_RESTORING = false;

    function formatDateTime(ts){
      try{
        const d = new Date(ts);
        const datePart = new Intl.DateTimeFormat('ar-SA', {weekday:'long', year:'numeric', month:'long', day:'numeric'}).format(d);
        const timePart = d.toLocaleTimeString('ar-SA', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
        return `${datePart} — ${timePart}`;
      }catch{ return '—'; }
    }

    function setSavingBadge(){
      saveStatusBadge.innerHTML = `<span class="saving-inline"><i class="spinner" aria-hidden="true"></i><span>جارٍ الحفظ…</span></span>`;
    }
    function setSavedBadge(ts){
      const when = ts ? formatDateTime(ts) : '—';
      saveStatusBadge.textContent = `آخر حفظ: ${when}`;
    }
    function setErrorBadge(){
      saveStatusBadge.textContent = 'تعذّر الحفظ (تحقق من الأذونات)';
    }

    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    function getCurrentState(){
      return {
        cycleLength: Number(cycleLengthSelect.value)||90,
        wakeDelay: clamp(Number(wakeDelay.value)||0, 0, 180),
        cBefore: clamp(cBefore, 0, 5),
        cAfter:  clamp(cAfter,  0, 5),
        gapAfter: clamp(Number(gapAfter.value)||0, 0, 120),
        lastSavedAt: Date.now()
      };
    }

    function applyState(state){
      if (!state) return;
      IS_RESTORING = true;
      try{
        cycleLengthSelect.value = String(clamp(state.cycleLength||90, 90, 110));
        wakeDelay.value = String(clamp(state.wakeDelay||0, 0, 180));
        gapAfter.value = String(clamp(state.gapAfter||0, 0, 120));
        cBefore = clamp(state.cBefore||0, 0, 5);
        cAfter  = clamp(state.cAfter||0,  0, 5);

        updateCycleUI();
        updatePills(false);
        autoUpdate();

        if (state.lastSavedAt) setSavedBadge(state.lastSavedAt);
        else setSavedBadge(null);
      } finally {
        IS_RESTORING = false;
      }
    }

    function saveSettings(){ // حفظ فعلي
      try{
        const state = getCurrentState();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        setSavedBadge(state.lastSavedAt);
      }catch(e){
        setErrorBadge();
      }
    }

    function scheduleAutoSave(){
      if (IS_RESTORING) return;
      setSavingBadge();
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(()=>{ saveSettings(); }, SAVE_DEBOUNCE_MS);
    }

    function renderPills(container, current, onPick){
      container.innerHTML='';
      const options = [0,1,2,3,4,5];
      options.forEach(n=>{
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'pill';
        b.setAttribute('aria-pressed', String(n===current));
        b.textContent = pillText(n);
        b.onclick = ()=>{ onPick(n) };
        container.appendChild(b);
      });
    }

    function updatePills(triggerSave = true){
      renderPills(pillsBefore, cBefore, (n)=>{ cBefore=n; updatePills(); autoUpdate(); if(triggerSave) scheduleAutoSave(); });
      renderPills(pillsAfter,  cAfter,  (n)=>{ cAfter=n;  updatePills(); autoUpdate(); if(triggerSave) scheduleAutoSave(); });
    }

    function ensureFajrDefault(){ if (!fajrTime.value){ fajrTime.value = '04:15'; } }

    // حساب وقت الاستيقاظ (أذان الفجر + التأخير)
    function getWakeTime(){
      ensureFajrDefault();
      const fajr = makeTodayAt(fajrTime.value || '04:15');
      const delay = Number(wakeDelay.value) || 0;
      return addMin(fajr, delay);
    }

    // —— معاينات
    function updatePreviews(){
      ensureFajrDefault();
      const wake = getWakeTime();
      const gap  = Number(gapAfter.value)||0;

      if (cBefore>0){
        const start = subMin(wake, cBefore*cycleMin);
        previewBefore.style.display = 'block';
        previewBefore.textContent = `ستنام من ${fmt(start)} حتى ${fmt(wake)} (${countWithWord(cBefore)}).`;
      } else {
        previewBefore.style.display = 'none';
        previewBefore.textContent = '';
      }

      if (cAfter>0){
        const startA = addMin(wake, gap);
        const endA   = addMin(startA, cAfter*cycleMin);
        previewAfter.style.display = 'block';
        previewAfter.textContent = `ستنام من ${fmt(startA)} حتى ${fmt(endA)} (${countWithWord(cAfter)}).`;
      } else {
        previewAfter.style.display = 'none';
        previewAfter.textContent = '';
      }
    }

    // —— اقتراحات وقت النوم المثالي
    function updateIdealHint(){
      ensureFajrDefault();
      const wake = getWakeTime();
      const opts = [];
      const targetCycles = Math.max(1, Math.ceil(360 / cycleMin)); // لتحقيق ٦+ ساعات
      for (let n=1; n<=5; n++){
        const start = subMin(wake, n*cycleMin);
        const tag = (n===targetCycles) ? ' (مقترح ٦+ ساعات)' : '';
        opts.push(`${fmt(start)} — ${n===1?'دورة واحدة':(n===2?'دورتان':`${n} دورات`)}${tag}`);
      }
      idealHint.textContent = `اقتراحات وقت النوم: ${opts.join(' • ')}`;
    }

    function totalLabel(cBefore, cAfter){
      const totalMin = (cBefore + cAfter) * cycleMin;
      const h = Math.floor(totalMin/60), m = totalMin%60;
      const hoursTxt = hoursWord(h) + (m ? ` و${m} دقيقة` : '');
      return {text:`إجمالي النوم: ${hoursTxt} (${countWithWord(cBefore + cAfter)})`, totalMin};
    }

    function setMeterClass(el, totalMin){
      el.classList.remove('meter-danger','meter-warn','meter-ok');
      if (totalMin < 240){ // أقل من 4 ساعات
        el.classList.add('meter-danger');
      } else if (totalMin < 360){ // 4 إلى أقل من 6
        el.classList.add('meter-warn');
      } else { // 6 ساعات فأكثر
        el.classList.add('meter-ok');
      }
    }

    function buildPlan(){
      ensureFajrDefault();
      const wake = getWakeTime();
      const gap  = Number(gapAfter.value)||0;

      if (cBefore===0 && cAfter===0){
        results.style.display = 'none';
        updateIdealHint();
        return;
      }

      let beforeText = '—';
      if (cBefore>0){
        const start = subMin(wake, cBefore*cycleMin);
        beforeText = humanSpan(start, wake) + ` (${countWithWord(cBefore)})`;
      } else {
        beforeText = 'لا يوجد نوم قبل الفجر';
      }

      let afterText = '—';
      if (cAfter>0){
        const startA = addMin(wake, gap);
        const endA   = addMin(startA, cAfter*cycleMin);
        afterText = humanSpan(startA, endA) + ` (${countWithWord(cAfter)})`;
      } else {
        afterText = 'لا يوجد نوم بعد الفجر';
      }

      beforeLine.textContent = beforeText;
      afterLine.textContent = afterText;
      results.style.display = 'block';

      const t = totalLabel(cBefore, cAfter);
      totalLbl.textContent = t.text;
      setMeterClass(totalLbl, t.totalMin);

      advice.innerHTML = '';
      if (t.totalMin > 360){
        advice.innerHTML = `<div class="ok">نوم العوافي! استمر إذا تحس بنشاط وتركيز.</div>`;
      } else if (t.totalMin < 360){
        advice.innerHTML = `<div class="danger"><b>ننصحك تنام أكثر:</b> عادة الجسم يحتاج ٦ ساعات+ عشان يكمل دورات النوم ويصلّح الطاقة والذاكرة. زوّد دورة قبل أو بعد الفجر حسب جدولك.</div>`;
      }

      updateIdealHint();
    }

    function updateWakeBadge(){
      const delay = Number(wakeDelay.value)||0;
      const wake  = getWakeTime();
      wakeBadge.textContent = `وقت الاستيقاظ: ${fmt(wake)} ${delay ? `(الأذان + ${delay} دقيقة)` : '(عند الأذان)'}`;
    }

    function autoUpdate(){
      updateWakeBadge();
      updatePreviews();
      buildPlan();
    }

    // ===== شارة اليوم (هجري + محلي) =====
    function updateTodayBadge(){
      const now = new Date();
      const hijri = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {
        weekday:'long', day:'numeric', month:'long', year:'numeric'
      }).format(now);
      const time = now.toLocaleTimeString('ar-SA', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
      todayBadge.textContent = `اليوم: ${hijri} - ${time}`;
    }

    // ===== جلب وقت الفجر/الشروق تلقائيًا من Aladhan =====
    function sanitizeTime(str){ const m = (str||'').match(/(\d{1,2}):(\d{2})/); return m ? `${m[1].padStart(2,'0')}:${m[2]}` : ''; }

    async function fetchFajrByCoords(lat, lon){
      const url = `https://api.aladhan.com/v1/timings?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&method=4&school=0`;
      const res = await fetch(url); if(!res.ok) throw new Error('HTTP');
      const json = await res.json(); if(json.code !== 200) throw new Error('API'); return json.data;
    }
    async function fetchFajrByCity(city='Riyadh', country='Saudi Arabia'){
      const url = `https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(city)}&country=${encodeURIComponent(country)}&method=4&school=0`;
      const res = await fetch(url); if(!res.ok) throw new Error('HTTP');
      const json = await res.json(); if(json.code !== 200) throw new Error('API'); return json.data;
    }

    async function setFajrAutomatically(){
      subtitleEl.textContent = 'جاري تحديد الموقع وجلب وقت الفجر…';
      let data = null;
      let sourceNote = '';

      if ('geolocation' in navigator){
        try{
          const pos = await new Promise((resolve, reject)=>{
            navigator.geolocation.getCurrentPosition(resolve, reject, {enableHighAccuracy:true, timeout:10000});
          });
          const {latitude, longitude} = pos.coords;
          data = await fetchFajrByCoords(latitude, longitude);
          sourceNote = `تم ضبط وقت الفجر تلقائيًا حسب موقعك (${latitude.toFixed(2)}, ${longitude.toFixed(2)}).`;
          subtitleEl.textContent = 'تم جلب وقت الفجر حسب موقعك.';
        }catch(e){
          // سنسقط إلى المدينة الافتراضية
        }
      }
      if (!data){
        try{
          data = await fetchFajrByCity('Riyadh','Saudi Arabia');
          sourceNote = 'تم ضبط وقت الفجر تلقائيًا (مدينة: الرياض).';
          subtitleEl.textContent = 'تم جلب وقت الفجر تلقائيًا (الرياض).';
        }catch(e){
          subtitleEl.textContent = 'تعذّر جلب وقت الفجر تلقائيًا؛ أدخله يدويًا.';
        }
      }

      if (data){
        const fajr = sanitizeTime(data.timings?.Fajr);
        const sunrise = sanitizeTime(data.timings?.Sunrise);
        if (fajr){
          fajrTime.value = fajr; // لا يُحفظ
          tzBadge.textContent = `المنطقة الزمنية: ${data.meta?.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone || '—'}`;
          autoNote.style.display = 'inline';
          autoNote.textContent = `${sourceNote} (المصدر: Aladhan).`;
        }
        sunriseBadge.textContent = `الشروق: ${sunrise || '—'}`;
        autoUpdate();
      }
    }

    // ===== Tutorial القديم =====
    const tutorialOverlay = document.getElementById('tutorialOverlay');
    const tutorialCard    = document.getElementById('tutorialCard');

    const learnSlides = [
      { t: 'وش يعني «دورة نوم»؟',
        c: `النوم يجي على دورات، والدورة عادة بين <b>٩٠–١١٠ دقيقة</b>...` },
      { t: 'ليه نهتم بمدة الدورة؟',
        c: `... (٩٠ أو ١٠٠ أو ١١٠ دقيقة) ...` },
      { t: 'كيف نركّبها مع صلاة الفجر؟',
        c: `نخطّط عدد الدورات قبل/بعد الفجر...` },
      { t: 'التعليمات السريعة',
        c: `<ol style="margin:6px 0 0 0;padding-inline-start:22px">
              <li><b>وقت الفجر:</b> يُجلب تلقائيًا عند الدخول (لا يُحفظ).</li>
              <li><b>مدة الدورة:</b> اختر ٩٠/١٠٠/١١٠ دقيقة.</li>
              <li><b>تأخير الاستيقاظ:</b> كم دقيقة بعد الأذان.</li>
              <li><b>الفاصل بعد الصلاة:</b> أدخل دقائق الوضوء والأذكار.</li>
              <li><b>عدد الدورات قبل/بعد الفجر:</b> اختر العدد.</li>
              <li>لا حاجة لحفظ يدوي — يتم الحفظ تلقائيًا.</li>
            </ol>`, final: true }
    ];

    const tutorialState = { mode:'question', step:0 };

    function renderTutorial(){
      let html = '';
      if (tutorialState.mode === 'question'){
        html = `
          <h2 id="tutorialTitle">يا هلا! تعرف وش تعني «دورة النوم»؟</h2>
          <p>ودّك نعرّفك عليها بسرعة قبل نبدأ ولا أمورك واضحة؟</p>
          <div class="row-actions">
            <label class="small"><input type="checkbox" id="dontShow"> لا تُظهر هذه التعليمات مرة أخرى</label>
            <div class="nav">
              <button id="yesBtn"  class="btn-secondary" type="button">نعم، واضح</button>
              <button id="noBtn"   class="btn-primary"   type="button">لا، علّمني</button>
            </div>
          </div>`;
      } else {
        const s = learnSlides[tutorialState.step];
        const isFirst = tutorialState.step === 0;
        const isFinal = !!s.final || tutorialState.step === learnSlides.length - 1;

        html = `
          <h2 id="tutorialTitle">${s.t}</h2>
          <div class="hint">${s.c}</div>
          <div class="row-actions">
            <label class="small"><input type="checkbox" id="dontShow"> لا تُظهر هذه التعليمات مرة أخرى</label>
            <div class="nav">
              <button id="prevBtn" class="btn-secondary" type="button" ${isFirst?'disabled':''}>السابق</button>
              <button id="nextBtn" class="btn-primary"   type="button">${isFinal?'ابدأ الآن':'التالي'}</button>
            </div>
          </div>`;
      }

      tutorialCard.innerHTML = html;

      const dontShow = document.getElementById('dontShow');
      if (dontShow) dontShow.checked = (localStorage.getItem('hideTutorial') === '1');

      const yesBtn  = document.getElementById('yesBtn');
      const noBtn   = document.getElementById('noBtn');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');

      if (yesBtn){ yesBtn.onclick = ()=>{ tutorialState.mode='direct'; tutorialState.step=learnSlides.findIndex(s=>s.final); if(tutorialState.step<0)tutorialState.step=learnSlides.length-1; renderTutorial(); }; }
      if (noBtn){  noBtn.onclick  = ()=>{ tutorialState.mode='learn'; tutorialState.step=0; renderTutorial(); }; }
      if (prevBtn){prevBtn.onclick= ()=>{ if (tutorialState.step>0){ tutorialState.step--; renderTutorial(); } }; }
      if (nextBtn){
        nextBtn.onclick = ()=>{
          const isFinal = (tutorialState.mode!=='question') && (tutorialState.step>=learnSlides.length-1 || learnSlides[tutorialState.step].final);
          if (isFinal){
            const dontShow = document.getElementById('dontShow');
            if (dontShow && dontShow.checked) localStorage.setItem('hideTutorial','1');
            closeTutorial();
          } else {
            tutorialState.step = Math.min(learnSlides.length-1, tutorialState.step+1);
            renderTutorial();
          }
        };
      }
    }

    function openTutorial(){
      if (localStorage.getItem('hideTutorial') === '1') return;
      tutorialState.mode = 'question'; tutorialState.step = 0;
      tutorialOverlay.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      renderTutorial();
    }
    function closeTutorial(){
      tutorialOverlay.style.display = 'none';
      document.body.style.overflow = '';
      const dontShow = document.getElementById('dontShow');
      if (dontShow && dontShow.checked) localStorage.setItem('hideTutorial','1');
    }
    tutorialOverlay.addEventListener('click', (e)=>{ if(e.target === tutorialOverlay) closeTutorial(); });

    // ===== Info modal (دورة النوم) =====
    const infoOverlay = document.getElementById('infoOverlay');
    const cycleInfoBtn = document.getElementById('cycleInfoBtn');
    const infoCloseBtn = document.getElementById('infoCloseBtn');
    function openInfo(){ infoOverlay.style.display='flex'; document.body.style.overflow='hidden'; }
    function closeInfo(){ infoOverlay.style.display='none'; document.body.style.overflow=''; }
    cycleInfoBtn.addEventListener('click', openInfo);
    infoCloseBtn.addEventListener('click', closeInfo);
    infoOverlay.addEventListener('click', (e)=>{ if(e.target === infoOverlay) closeInfo(); });

    // ===== Events =====
    fajrTime.addEventListener('input', ()=>{ // وقت الفجر لا يُحفظ
      autoUpdate();
      updateIdealHint();
    });

    gapAfter.addEventListener('input', ()=>{ autoUpdate(); scheduleAutoSave(); });
    wakeDelay.addEventListener('input', ()=>{ autoUpdate(); updateIdealHint(); scheduleAutoSave(); });
    autoResetBtn.addEventListener('click', setFajrAutomatically);
    cycleLengthSelect.addEventListener('change', ()=>{ updateCycleUI(); autoUpdate(); updateIdealHint(); scheduleAutoSave(); });

    // ===== الحفظ والاسترجاع (localStorage) =====
    function loadSettings(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw){ setSavedBadge(null); return; }
        const state = JSON.parse(raw);
        applyState(state);
      }catch(e){
        setSavedBadge(null);
      }
    }

    // ===== Init =====
    (function init(){
      updateTodayBadge();
      setInterval(updateTodayBadge, 1000);

      tzBadge.textContent = `المنطقة الزمنية: ${Intl.DateTimeFormat().resolvedOptions().timeZone || '—'}`;
      updatePills(false);   // أول مرّة بدون حفظ تلقائي
      loadSettings();
      updateCycleUI();
      autoUpdate();
      updateIdealHint();
      setFajrAutomatically(); // وقت الأذان/الشروق تلقائي
      openTutorial();
    })();
  </script>
</body>
</html>